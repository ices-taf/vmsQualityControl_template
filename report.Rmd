---
title: "VMS QC report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

<style>
#TOC {
  background:url("http://www.ices.dk/_layouts/15/1033/images/icesimg/iceslogo.png") ;
  background-size: contain;
  padding-top: 100px !important;
  background-repeat: no-repeat;
  position: fixed;
  font-size: 12px;
  left: 0;
  top: 0;
  width: 200px;
  height: 80%;
  overflow:auto;
}
</style>



```{r setup, eval=TRUE, echo=FALSE, cache=FALSE}
library(knitr)
library(dplyr)
library(tidyr)
library(DT)
library(plotly)
library(leaflet)
library(sf)

opts_chunk$set(
  comment = NA,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  echo = FALSE,
  eval = TRUE
)

options(digits = 4)
```

<!------------------------------------------------------------------------------
Tables & Figures VMS
---------------------------------------------------------------------------- -->

# VMS data submission QC

## Character data

```{r utils-1}
plot_ly_char <- function(data, color = NULL) {
  data %>%
    plot_ly(
      x = ~year,
      y = ~n,
      color = color,
      type = "bar"
    ) %>%
    layout(barmode = "stack")
}

datatable_char <- function(data) {
  data %>%
    spread(year, n) %>%
    datatable(
      extensions = "Buttons",
      options = list(
        dom = "Bfrtip",
        buttons =
          list("copy", "print", list(
            extend = "collection",
            buttons = c("csv", "excel", "pdf"),
            text = "Download"
          )),
        pageLength = -1
      ),
      rownames = FALSE
    )
}
```


### number of records

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName1"> show/hide Table </button>

<div id="BlockName1" class="collapse">
```{r records-by-year-table, results='asis'}
read.taf("report/records_per_year.csv") %>%
  datatable_char()
```
</div>

```{r records-by-year-plot}
read.taf("report/records_per_year.csv") %>%
  plot_ly_char()
```

### Frequency by month:

```{r records-by-month-table, results='asis'}
read.taf("report/records_per_month.csv") %>%
  datatable_char()
```

```{r records-by-month-plot}
read.taf("report/records_per_month.csv") %>%
  plot_ly_char(~ factor(month))
```


### Distribution of number of unique vessels per c-square:

### Frequency of vessel length categories

```{r records-per-vessel-length-cat-table, results='asis'}
read.taf("report/records_per_vessel_length_cat.csv") %>%
  datatable_char()
```

```{r records-per-vessel-length-cat-plot}
read.taf("report/records_per_vessel_length_cat.csv") %>%
  plot_ly_char(~ factor(vessel_length_category))
```

### Frequency of gear codes

```{r records-per-gear-code-table, results='asis'}
read.taf("report/records_per_gear_code.csv") %>%
  datatable_char()
```

```{r records-per-gear-code-plot}
read.taf("report/records_per_gear_code.csv") %>%
  plot_ly_char(~ factor(gear_code))
```

### Number of unique DCF Level 6 codes

```{r unique_level6_code_by_year, results='asis'}
read.taf("report/unique_level6_code_by_year.csv") %>%
  datatable_char()
```

### Top 5 DCF Level 6 codes


```{r level6_code_by_year_table, results='asis'}
read.taf("report/records_per_metier_level_6.csv") %>%
  datatable_char()
```

```{r level6_code_by_year_plot}
read.taf("report/records_per_metier_level_6.csv") %>%
  plot_ly_char(~ factor(LE_MET_level6))
```


## Numeric data

```{r utils-2}
plot_ly_num <- function(data, x) {
  data %>%
    plot_ly(alpha = 0.6) %>%
    add_histogram(x = x, color = ~ factor(year), nbins = 5) %>%
    layout(barmode = "overlay")
}
```


### Average fishing speed

```{rn average_fishing_speed_plot}
read.taf("data/vms.csv") %>%
  plot_ly_num(~avg_fishing_speed)
```

### Average fishing hours:

```{r average_fishing_hours_plot}
read.taf("data/vms.csv") %>%
  plot_ly_num(~ I(fishing_hours^0.5))
```

### Average length:

```{r average_overall_length_plot}
read.taf("data/vms.csv") %>%
  plot_ly_num(~avg_oal)
```


### Average kW:

```{r average_kw_plot}
read.taf("data/vms.csv") %>%
  plot_ly_num(~avg_kw)
```

### Average kW-hours:

```{r average_wk_fishing_hours_plot}
read.taf("data/vms.csv") %>%
  plot_ly_num(~I(kw_fishinghours^.5))
```



## Time series



## Spatial data

### Spatial extent
```{r spatial-extent-by-year-table, results='asis'}
read.taf("report/spatial_extent_by_year.csv") %>%
  datatable(
    options = list(
      dom = "t",
      pageLength = -1
    ),
    rownames = FALSE
  ) %>%
  formatRound(
    columns = c("min lon", "max lon", "min lat", "max lat"),
    digits = 3
  )
```

```{r spatial-extent-by-year-map}
coverage <- st_read("report/coverage.geojson")
years <- coverage$year

m <-
  leaflet() %>%
  addTiles() %>%
  addProviderTiles(providers$Esri.OceanBasemap)

for (layer in years) {
  m <-
    addPolygons(
      m,
      data = coverage %>% filter(year == layer),
      fillColor = "red", # rainbow(length(years))[layer %% min(years) + 1],
      weight = 0,
      opacity = 1,
      fillOpacity = 0.4,
      stroke = FALSE,
      group = paste(layer)
    )
}
m <-
  addLayersControl(
    m,
    baseGroups = paste(years),
    options = layersControlOptions(collapsed = FALSE)
  )

m
```

### Spatial extend of 3 most dominant gears

```{r spatial-distribution-by-gear-map}
gears_coverage <- st_read("report/gears_coverage.geojson")

cols <- rev(heat.colors(9))

ms <-
lapply(unique(gears_coverage$gear_code), function(gear) {
  gear_coverage <- gears_coverage %>% filter(gear_code == gear)
  years <- gear_coverage$year

  m <-
    leaflet() %>%
    addTiles() %>%
    addProviderTiles(providers$Esri.OceanBasemap)

  for (layer in years) {
    gear_coverage_layer <- gear_coverage %>% filter(year == layer)
    m <-
      addPolygons(
        m,
        data = gear_coverage_layer,
        fillColor = cols[gear_coverage_layer$fillColour], # rainbow(length(years))[layer %% min(years) + 1],
        weight = 0,
        opacity = 1,
        fillOpacity = .7,
        stroke = FALSE,
        group = paste(layer)
      )
  }
  m <-
    addLayersControl(
      m,
      baseGroups = paste(years),
      options = layersControlOptions(collapsed = FALSE),
    ) %>%
    addLegend(
      "bottomright",
      colors = cols[gear_coverage_layer$fillColour],
      labels = gear_coverage_layer$fishing_days,
      title = gear,
      opacity = 1
    )

  m
})

ms[[1]]
ms[[2]]
ms[[3]]
```
